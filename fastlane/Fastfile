# frozen_string_literal: true

default_platform(:mac)

# App Store Connect API Key configuration
API_KEY_ID = "S34998ZCRT"
API_KEY_ISSUER_ID = "c98b1e0a-8d10-4fce-a417-536b31c09bfb"
API_KEY_PATH = File.expand_path("../../..", __dir__) + "/../.private_keys/AuthKey_S34998ZCRT.p8"

platform :mac do
  desc "Get App Store Connect API key"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id: API_KEY_ID,
      issuer_id: API_KEY_ISSUER_ID,
      key_filepath: API_KEY_PATH,
      duration: 1200,
      in_house: false
    )
  end

  desc "Notarize the DMG for distribution"
  lane :notarize_dmg do
    notarize(
      package: "releases/SaneBar-1.0.0.dmg",
      bundle_id: "com.sanebar.app",
      api_key: api_key,
      print_log: true,
      verbose: true
    )
  end

  desc "Build, sign, and notarize for release"
  lane :release do
    build_mac_app(
      scheme: "SaneBar",
      export_method: "developer-id",
      output_directory: "build",
      output_name: "SaneBar"
    )

    notarize(
      package: "build/SaneBar.app",
      bundle_id: "com.sanebar.app",
      api_key: api_key,
      print_log: true
    )
  end
end
